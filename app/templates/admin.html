{% extends 'base.html' %}
{% block title %}PISHOW Control{% endblock %}
{% block content %}
  <h1>PISHOW Control Panel</h1>
  <p>
    Upload images or videos. Supported images: {{ current_app.config['ALLOWED_IMAGE_EXTENSIONS']|join(', ') }}.
    Supported videos: {{ current_app.config['ALLOWED_VIDEO_EXTENSIONS']|join(', ') }}.
    Max file size: {{ max_upload_mb }} MB.
  </p>

  <section>
    <form id="upload-form" enctype="multipart/form-data">
      <label>
        Select media
        <input type="file" id="media-upload" name="file" accept="image/*,video/*" required />
      </label>
      <button type="submit">Upload</button>
      <span id="upload-status"></span>
    </form>
  </section>

  <section>
    <h2>Library</h2>
    <div class="media-grid" id="media-grid">
      {% for media in media_items %}
        <article class="media-card" data-media-id="{{ media.id }}">
          <header>{{ media.original_name }} ({{ media.media_type }})</header>
          {% if media.media_type == 'image' %}
            <img src="{{ url_for('main.media_file', filename=media.filename) }}" alt="{{ media.original_name }}" />
          {% else %}
            <video src="{{ url_for('main.media_file', filename=media.filename) }}" muted loop></video>
          {% endif %}
          <footer>
            {% if media.media_type == 'image' %}
              <label>
                Default duration (seconds)
                <input type="number" min="1" name="duration" value="{{ media.duration_default or 8 }}" />
              </label>
            {% endif %}
            <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
              <button class="small secondary" data-action="set-duration" data-id="{{ media.id }}">Save Duration</button>
              <button class="small" data-action="add-to-playlist" data-id="{{ media.id }}">Add to Playlist</button>
              <button class="small contrast" data-action="delete-media" data-id="{{ media.id }}">Delete</button>
            </div>
          </footer>
        </article>
      {% else %}
        <p>No media uploaded yet.</p>
      {% endfor %}
    </div>
  </section>

  <section class="playlist-builder">
    <h2>Active Playlist</h2>
    <ol class="playlist-items" id="playlist-items"></ol>
    <div style="display:flex; gap:0.5rem;">
      <button id="save-playlist">Send to Projector</button>
      <button class="secondary" id="clear-playlist">Clear Playlist</button>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    window.initialMedia = {{ media_items | tojson }};
    window.initialPlaylist = {{ playlist | tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
{% endblock %}
